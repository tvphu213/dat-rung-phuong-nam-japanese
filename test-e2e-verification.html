<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Lazy Loading Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-step {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #2196F3;
            background-color: #E3F2FD;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass {
            background-color: #C8E6C9;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }
        .fail {
            background-color: #FFCDD2;
            color: #C62828;
            border-left: 4px solid #F44336;
        }
        .pending {
            background-color: #FFF9C4;
            color: #F57F17;
            border-left: 4px solid #FFC107;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #results {
            margin-top: 20px;
        }
        .test-details {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .network-log {
            background-color: #263238;
            color: #A5D6A7;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .summary {
            background-color: #1976D2;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .summary h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>üß™ End-to-End Lazy Loading Verification Test</h1>

    <div class="test-section">
        <h2>Test Overview</h2>
        <p>This automated test verifies all lazy loading functionality including:</p>
        <ul>
            <li>Initial page load with only chapter 1</li>
            <li>TOC click-based chapter loading</li>
            <li>Scroll-based progressive loading</li>
            <li>Japanese tab functionality</li>
            <li>Existing features (back-to-top, progress bar)</li>
        </ul>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        let testResults = [];
        let networkRequests = [];

        // Monitor fetch requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            const timestamp = new Date().toISOString().substr(11, 12);
            networkRequests.push(`[${timestamp}] FETCH: ${url}`);
            return originalFetch.apply(this, args);
        };

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            networkRequests = [];
        }

        function addTestResult(testName, status, details) {
            testResults.push({name: testName, status: status, details: details});
            renderResults();
        }

        function renderResults() {
            const resultsDiv = document.getElementById('results');
            let html = '';

            testResults.forEach((result, index) => {
                const statusClass = result.status === 'PASS' ? 'pass' : result.status === 'FAIL' ? 'fail' : 'pending';
                html += `
                    <div class="test-section">
                        <h3>Test ${index + 1}: ${result.name}</h3>
                        <div class="test-result ${statusClass}">
                            ${result.status}
                        </div>
                        <div class="test-details">${result.details}</div>
                    </div>
                `;
            });

            // Add network log
            if (networkRequests.length > 0) {
                html += `
                    <div class="test-section">
                        <h3>üì° Network Activity Log</h3>
                        <div class="network-log">
                            ${networkRequests.join('\n')}
                        </div>
                    </div>
                `;
            }

            // Add summary
            const passCount = testResults.filter(r => r.status === 'PASS').length;
            const failCount = testResults.filter(r => r.status === 'FAIL').length;
            const totalCount = testResults.length;

            html += `
                <div class="summary">
                    <h2>üìä Test Summary</h2>
                    <p>Total Tests: ${totalCount}</p>
                    <p>‚úÖ Passed: ${passCount}</p>
                    <p>‚ùå Failed: ${failCount}</p>
                    <p>Success Rate: ${totalCount > 0 ? Math.round(passCount/totalCount*100) : 0}%</p>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function test1_InitialPageLoad() {
            networkRequests = []; // Clear network log
            const testName = "Initial Page Load - Only Chapter 1";

            try {
                // Open index.html in iframe to simulate fresh load
                const iframe = document.createElement('iframe');
                iframe.src = 'index.html';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                await sleep(2000); // Wait for page load

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const chapter1 = iframeDoc.getElementById('chapter-1') || iframeDoc.getElementById('chapter-ja-1');

                if (!chapter1) {
                    throw new Error('Chapter 1 not found');
                }

                const hasContent = chapter1.textContent.trim().length > 100;
                const chapter2 = iframeDoc.getElementById('chapter-2') || iframeDoc.querySelector('[data-chapter-num="2"]');
                const chapter2Empty = chapter2 && chapter2.textContent.trim().length < 100;

                document.body.removeChild(iframe);

                if (hasContent && chapter2Empty) {
                    addTestResult(testName, 'PASS',
                        'Chapter 1 has content, Chapter 2+ are empty placeholders. ' +
                        `Chapter 1 content length: ${chapter1.textContent.trim().length} chars`);
                } else {
                    addTestResult(testName, 'FAIL',
                        `Chapter 1 content: ${hasContent}, Chapter 2 empty: ${chapter2Empty}`);
                }
            } catch (error) {
                addTestResult(testName, 'FAIL', `Error: ${error.message}`);
            }
        }

        async function test2_TOCChapterClick() {
            const testName = "TOC Click - Load Chapter 10";
            networkRequests.push('--- Starting Test 2: TOC Click ---');

            try {
                // We need to test in the actual index.html context
                // This test provides instructions for manual verification
                const instructions = `
Manual Verification Required:
1. Open http://localhost:8000/index.html in a new tab
2. Open DevTools Network tab
3. Filter by "chapter" to see chapter JSON requests
4. Click on "Ch∆∞∆°ng 10" in the Table of Contents
5. Verify that chapter-10.json is loaded in Network tab
6. Verify that the page scrolls to Chapter 10
7. Verify that Chapter 10 content is displayed

Expected: chapter-10.json appears in Network tab, page scrolls to Chapter 10, content visible
                `;

                addTestResult(testName, 'PENDING', instructions);
            } catch (error) {
                addTestResult(testName, 'FAIL', `Error: ${error.message}`);
            }
        }

        async function test3_ScrollBasedLoading() {
            const testName = "Scroll-Based Progressive Loading - Chapters 2-5";
            networkRequests.push('--- Starting Test 3: Scroll Loading ---');

            const instructions = `
Manual Verification Required:
1. Reload http://localhost:8000/index.html
2. Open DevTools Network tab, filter by "chapter"
3. Clear network log
4. Slowly scroll down through chapters 2, 3, 4, 5
5. Observe network requests as you scroll
6. Verify loading spinners appear before content

Expected: chapter-2.json, chapter-3.json, chapter-4.json, chapter-5.json load progressively
          as you scroll near each chapter. Loading spinner appears, then content.
            `;

            addTestResult(testName, 'PENDING', instructions);
        }

        async function test4_JapaneseTabSwitch() {
            const testName = "Japanese Tab - Load Chapter JA-1";
            networkRequests.push('--- Starting Test 4: Japanese Tab ---');

            const instructions = `
Manual Verification Required:
1. On http://localhost:8000/index.html
2. Click the "Êó•Êú¨Ë™û" (Japanese) tab
3. Open DevTools Network tab
4. Verify the Japanese tab content is displayed
5. Check if chapter-ja-1.json was loaded (if not already embedded)
6. Verify Japanese Chapter 1 content is visible

Expected: Japanese tab switches successfully, chapter-ja-1.json may be loaded,
          Japanese content displayed correctly
            `;

            addTestResult(testName, 'PENDING', instructions);
        }

        async function test5_JapaneseTOCClick() {
            const testName = "Japanese TOC Click - Load Chapter JA-15";
            networkRequests.push('--- Starting Test 5: Japanese TOC Click ---');

            const instructions = `
Manual Verification Required:
1. While on Japanese tab (http://localhost:8000/index.html)
2. Open DevTools Network tab, filter by "chapter"
3. Click on Japanese "Á¨¨ÂçÅ‰∫îÁ´†" (Chapter 15) in TOC
4. Verify chapter-ja-15.json loads in Network tab
5. Verify page scrolls to Japanese Chapter 15
6. Verify Japanese Chapter 15 content is displayed

Expected: chapter-ja-15.json appears in Network tab, page scrolls to Japanese Chapter 15,
          Japanese content visible
            `;

            addTestResult(testName, 'PENDING', instructions);
        }

        async function test6_ExistingFeatures() {
            const testName = "Existing Features - Back-to-Top & Progress Bar";
            networkRequests.push('--- Starting Test 6: Existing Features ---');

            const instructions = `
Manual Verification Required:
1. On http://localhost:8000/index.html
2. Scroll down the page to middle or bottom
3. Verify reading progress bar at top updates as you scroll
4. Click "Back to Top" button (usually bottom-right corner)
5. Verify page smoothly scrolls back to top
6. Test tab switching still works (Vietnamese ‚Üî Japanese)
7. Verify TOC highlighting updates as you scroll

Expected: All existing features work correctly:
          ‚úì Progress bar updates with scroll position
          ‚úì Back-to-top button scrolls to page top
          ‚úì Tab switching works smoothly
          ‚úì TOC highlighting follows scroll position
            `;

            addTestResult(testName, 'PENDING', instructions);
        }

        async function runAllTests() {
            clearResults();
            addTestResult('Starting E2E Test Suite', 'PENDING', 'Initializing tests...');

            await test1_InitialPageLoad();
            await sleep(500);

            await test2_TOCChapterClick();
            await sleep(500);

            await test3_ScrollBasedLoading();
            await sleep(500);

            await test4_JapaneseTabSwitch();
            await sleep(500);

            await test5_JapaneseTOCClick();
            await sleep(500);

            await test6_ExistingFeatures();

            // Update first result
            testResults[0] = {
                name: 'E2E Test Suite Initialized',
                status: 'PASS',
                details: `All ${testResults.length - 1} test scenarios loaded. Complete manual verification steps above.`
            };
            renderResults();
        }

        // Auto-run on load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('E2E Verification Test Page Loaded');
            console.log('Click "Run All Tests" to start verification');
        });
    </script>
</body>
</html>
